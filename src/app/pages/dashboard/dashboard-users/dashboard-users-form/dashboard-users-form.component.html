<form [formGroup]="form" (ngSubmit)="onSubmit()" class="mat-elevation-z4 user-form">
    <h2 class="title">
        {{ isEdit ? 'Modifier l’utilisateur' : 'Ajouter un utilisateur' }}
    </h2>

    <!-- ===================== PERSON ===================== -->
    <fieldset class="section">
        <legend>Informations personnelles</legend>

        <div class="grid">
            <mat-form-field appearance="outline">
                <mat-label>Prénom</mat-label>
                <input matInput formControlName="firstName" autocomplete="given-name" />
                <mat-error *ngIf="hasError('firstName','required')">
                    Le prénom est requis
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Nom</mat-label>
                <input matInput formControlName="lastName" autocomplete="family-name" />
                <mat-error *ngIf="hasError('lastName','required')">
                    Le nom est requis
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" type="email" autocomplete="email" />
                <mat-error *ngIf="hasError('email','required')">
                    L’email est requis
                </mat-error>
                <mat-error *ngIf="hasError('email','email')">
                    Format d’email invalide
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Téléphone</mat-label>
                <input matInput formControlName="phone" type="tel" autocomplete="tel" />
                <mat-error *ngIf="hasError('phone','required')">
                    Le téléphone est requis
                </mat-error>
            </mat-form-field>

            <!-- Adresse - lignes pleine largeur à partir de 768px (voir CSS) -->
            <mat-form-field appearance="outline">
                <mat-label>Adresse (n° et rue)</mat-label>
                <input matInput formControlName="line1" autocomplete="address-line1" />
                <mat-error *ngIf="hasError('line1','requiredIfStarted')">
                    Adresse incomplète
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Complément d’adresse</mat-label>
                <input matInput formControlName="line2" autocomplete="address-line2" />
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Ville</mat-label>
                <input matInput formControlName="city" autocomplete="address-level2" />
                <mat-error *ngIf="hasError('city','requiredIfStarted')">
                    Adresse incomplète
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Code postal</mat-label>
                <input matInput formControlName="postalCode" autocomplete="postal-code" />
                <mat-error *ngIf="hasError('postalCode','requiredIfStarted')">
                    Adresse incomplète
                </mat-error>
            </mat-form-field>
        </div>
    </fieldset>

    <mat-divider class="my-4"></mat-divider>

    <!-- ===================== ACCOUNT (CREATION) ===================== -->
    <ng-container *ngIf="!hasExistingAccount; else accountEdit">
        <fieldset class="section">
            <legend>Compte</legend>

            <!-- BOUTON À LA PLACE DU SLIDE TOGGLE -->
            <button class="account-btn" mat-stroked-button color="primary"
                    type="button"
                    (click)="toggleAttachAccount()">
                {{ form.get('attachAccount')!.value ? 'Retirer le compte' : 'Associer un compte' }}
            </button>

            <!-- SECTION COMPTE -->
            <div class="grid" *ngIf="form.get('attachAccount')!.value">
                <mat-form-field appearance="outline">
                    <mat-label>Identifiant</mat-label>
                    <input matInput formControlName="username" required autocomplete="username" />
                    <mat-error *ngIf="hasError('username','required')">
                        L’identifiant est requis
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Rôle</mat-label>
                    <mat-select formControlName="role" required>
                        <mat-option *ngFor="let r of roles" [value]="r">{{ r.id }}</mat-option>
                    </mat-select>
                    <mat-error *ngIf="hasError('role','required')">
                        Le rôle est requis
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Mot de passe</mat-label>
                    <input matInput type="password" formControlName="password" required autocomplete="new-password" />
                    <mat-error *ngIf="hasError('password','required')">
                        Le mot de passe est requis
                    </mat-error>
                </mat-form-field>

                <div class="row">
                    <mat-slide-toggle formControlName="enabled">Activer le compte</mat-slide-toggle>
                </div>
            </div>
        </fieldset>
    </ng-container>

    <!-- ===================== ACCOUNT (EDITION) ===================== -->
    <ng-template #accountEdit>
        <fieldset class="section">
            <legend>Compte existant</legend>
            <h3 class="sub-title">Paramètres du compte</h3>

            <div class="grid">
                <mat-form-field appearance="outline">
                    <mat-label>Identifiant</mat-label>
                    <input matInput formControlName="username" required autocomplete="username" />
                    <mat-error *ngIf="hasError('username','required')">
                        L’identifiant est requis
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Rôle</mat-label>
                    <mat-select formControlName="role" [compareWith]="compareRole" required>
                        <mat-option *ngFor="let r of roles" [value]="r">{{ r.id }}</mat-option>
                    </mat-select>
                    <mat-error *ngIf="hasError('role','required')">
                        Le rôle est requis
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                    <mat-label>Nouveau mot de passe (optionnel)</mat-label>
                    <input matInput type="password" formControlName="password" autocomplete="new-password" />
                    <!-- pas d’erreur ici, le mot de passe est optionnel en édition -->
                </mat-form-field>

                <div class="row">
                    <mat-slide-toggle formControlName="enabled">Compte activé</mat-slide-toggle>
                </div>
            </div>
        </fieldset>
    </ng-template>

    <!-- ===================== ACTIONS ===================== -->
    <div class="buttons">
        <button mat-stroked-button type="button" (click)="returnDashboard()">Annuler</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || saving">
            {{ isEdit ? 'Enregistrer' : 'Ajouter' }}
        </button>
    </div>
</form>
